<!-- ============================================================================ -->
<!-- admin/flights.html - Admin Flight Management (WITH EDIT FEATURE) -->
<!-- ============================================================================ -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head th:replace="~{fragments/layout :: head('Manage Flights - Admin')}"></head>
    <body>

        <nav th:replace="~{fragments/layout :: admin-navbar}"></nav>

        <main class="container-fluid mt-4">
            <div class="row">
                <!-- Sidebar -->
                <div class="col-md-2">
                    <div class="list-group">
                        <a th:href="@{/admin/dashboard}" class="list-group-item list-group-item-action">
                            <i class="bi bi-speedometer2"></i> Dashboard
                        </a>
                        <a th:href="@{/admin/flights}" class="list-group-item list-group-item-action active">
                            <i class="bi bi-airplane"></i> Flights
                        </a>
                        <a th:href="@{/admin/users}" class="list-group-item list-group-item-action ">
                            <i class="bi bi-people"></i> Users
                        </a>
                        <a th:href="@{/admin/bookings}" class="list-group-item list-group-item-action">
                            <i class="bi bi-ticket"></i> Bookings
                        </a>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="col-md-10">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="bi bi-airplane"></i> Manage Flights</h2>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addFlightModal">
                            <i class="bi bi-plus-circle"></i> Add Flight
                        </button>
                    </div>

                    <!-- Flights Table -->
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>ID</th>
                                            <th>Flight Number</th>
                                            <th>Route</th>
                                            <th>Departure</th>
                                            <th>Arrival</th>
                                            <th>Price</th>
                                            <th>Available Seats</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="flight : ${flights}">
                                            <td th:text="${flight.id}">1</td>
                                            <td>
                                                <strong th:text="${flight.flightNumber}">VN101</strong>
                                                <br>
                                                <small class="text-muted" th:text="${flight.aircraft.modelName}">
                                                    Boeing 737
                                                </small>
                                            </td>
                                            <td>
                                                <span th:text="${flight.route.origin}">Hanoi</span>
                                                <i class="bi bi-arrow-right"></i>
                                                <span th:text="${flight.route.destination}">Ho Chi Minh City</span>
                                            </td>
                                            <td th:text="${#temporals.format(flight.departureTime, 'HH:mm dd/MM/yyyy')}">
                                                06:00 05/11/2025
                                            </td>
                                            <td th:text="${#temporals.format(flight.arrivalTime, 'HH:mm dd/MM/yyyy')}">
                                                08:15 05/11/2025
                                            </td>
                                            <td th:text="${#numbers.formatDecimal(flight.price, 0, 'COMMA', 0, 'POINT')}">
                                                1,500,000
                                            </td>
                                            <td>
                                                <span class="badge" 
                                                      th:classappend="${flight.availableSeats > 50 ? 'bg-success' : 
                                                      (flight.availableSeats > 20 ? 'bg-warning' : 'bg-danger')}"
                                                      th:text="${flight.availableSeats}">
                                                    150
                                                </span>
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <button class="btn btn-outline-primary" 
                                                            th:onclick="'editFlight(' + ${flight.id} + ')'">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    <button class="btn btn-outline-danger" 
                                                            th:onclick="'deleteFlight(' + ${flight.id} + ')'">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- ========== ADD FLIGHT MODAL ========== -->
        <div class="modal fade" id="addFlightModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <form id="addFlightForm">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="bi bi-plus-circle"></i> Add New Flight
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Flight Number</label>
                                    <input type="text" class="form-control" id="flightNumber" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Price (VND)</label>
                                    <input type="number" class="form-control" id="price" required>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Route</label>
                                    <select class="form-select" id="routeId" required>
                                        <option value="">Select Route</option>
                                        <option th:each="route : ${routes}"
                                                th:value="${route.id}"
                                                th:text="${route.origin} + ' → ' + ${route.destination}">
                                            Hanoi → Ho Chi Minh City
                                        </option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Aircraft</label>
                                    <select class="form-select" id="aircraftId" required>
                                        <option value="">Select Aircraft</option>
                                        <option th:each="ac : ${aircrafts}"
                                                th:value="${ac.id}"
                                                th:text="${ac.modelName} + ' (' + ${ac.capacity} + ' seats)'">
                                            Boeing 737 (189 seats)
                                        </option>
                                    </select>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Departure Time</label>
                                    <input type="datetime-local" class="form-control" id="departureTime" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Arrival Time</label>
                                    <input type="datetime-local" class="form-control" id="arrivalTime" required>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Available Seats</label>
                                    <input type="number" class="form-control" id="availableSeats" required>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save Flight</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- ========== EDIT FLIGHT MODAL ========== -->
        <div class="modal fade" id="editFlightModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <form id="editFlightForm">
                        <input type="hidden" id="editFlightId">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="bi bi-pencil"></i> Edit Flight
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Flight Number</label>
                                    <input type="text" class="form-control" id="editFlightNumber" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Price (VND)</label>
                                    <input type="number" class="form-control" id="editPrice" required>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Route</label>
                                    <select class="form-select" id="editRouteId" required>
                                        <option value="">Select Route</option>
                                        <option th:each="route : ${routes}"
                                                th:value="${route.id}"
                                                th:text="${route.origin} + ' → ' + ${route.destination}">
                                            Hanoi → Ho Chi Minh City
                                        </option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Aircraft</label>
                                    <select class="form-select" id="editAircraftId" required>
                                        <option value="">Select Aircraft</option>
                                        <option th:each="ac : ${aircrafts}"
                                                th:value="${ac.id}"
                                                th:text="${ac.modelName} + ' (' + ${ac.capacity} + ' seats)'">
                                            Boeing 737 (189 seats)
                                        </option>
                                    </select>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Departure Time</label>
                                    <input type="datetime-local" class="form-control" id="editDepartureTime" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Arrival Time</label>
                                    <input type="datetime-local" class="form-control" id="editArrivalTime" required>
                                </div>

                                <div class="col-md-6">
                                    <label class="form-label">Available Seats</label>
                                    <input type="number" class="form-control" id="editAvailableSeats" required>
                                </div>
                            </div>

                            <!-- Warning message -->
                            <div class="alert alert-warning mt-3" role="alert">
                                <i class="bi bi-exclamation-triangle"></i>
                                <strong>Note:</strong> You cannot edit a flight if it has active bookings (Pending or Confirmed).
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Update Flight</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <footer th:replace="~{fragments/layout :: footer}"></footer>
        <div th:replace="~{fragments/layout :: scripts}"></div>

        <script th:inline="javascript">
            const contextPath = /*[[@{/}]]*/ '/';

            // ========== DELETE FLIGHT ==========
            async function deleteFlight(flightId) {
                if (!confirm('Are you sure you want to delete this flight?')) {
                    return;
                }
                try {
                    const response = await fetch(contextPath + `api/admin/flights/${flightId}`, {
                        method: 'DELETE'
                    });
                    const result = await response.json();
                    if (result.success) {
                        alert('Flight deleted successfully!');
                        location.reload();
                    } else {
                        alert('Failed to delete flight: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred. Please try again.');
                }
            }

            // ========== EDIT FLIGHT - LOAD DATA (ĐÃ SỬA) ==========
            async function editFlight(flightId) {
                try {
                    // Fetch flight details from server
                    const response = await fetch(contextPath + `api/admin/flights`);
                    const result = await response.json();

                    if (result.success) {
                        const flight = result.data.find(f => f.id === flightId);

                        if (!flight) {
                            alert('Flight not found');
                            return;
                        }

                        // Populate form fields
                        document.getElementById('editFlightId').value = flight.id;
                        document.getElementById('editFlightNumber').value = flight.flightNumber;
                        document.getElementById('editPrice').value = flight.price;
                        document.getElementById('editRouteId').value = flight.route.id; // Lấy ID từ object RouteInfo
                        document.getElementById('editAircraftId').value = flight.aircraftId; // <-- SỬA Ở ĐÂY (dùng ID trực tiếp)

                        // Format datetime for input
                        document.getElementById('editDepartureTime').value = formatDateTimeForInput(flight.departureTime);
                        document.getElementById('editArrivalTime').value = formatDateTimeForInput(flight.arrivalTime);
                        document.getElementById('editAvailableSeats').value = flight.availableSeats;

                        // Show modal
                        var editModal = new bootstrap.Modal(document.getElementById('editFlightModal'));
                        editModal.show();
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to load flight data');
                }
            }

            // (Hàm getAircraftIdByModel đã bị xóa vì không cần nữa)

            // Helper function to format datetime from API response
            function formatDateTimeForInput(apiDate) {
                let dateObj;

                if (Array.isArray(apiDate)) {
                    // Handle array format: [YYYY, MM, DD, HH, MM]
                    dateObj = new Date(apiDate[0], apiDate[1] - 1, apiDate[2], apiDate[3], apiDate[4]);
                } else if (typeof apiDate === 'string') {
                    // Handle string format: "2025-11-05T06:00:00"
                    dateObj = new Date(apiDate);
                } else {
                    return '';
                }

                // Format to "YYYY-MM-DDTHH:MM" for datetime-local input
                const year = dateObj.getFullYear();
                const month = String(dateObj.getMonth() + 1).padStart(2, '0');
                const day = String(dateObj.getDate()).padStart(2, '0');
                const hours = String(dateObj.getHours()).padStart(2, '0');
                const minutes = String(dateObj.getMinutes()).padStart(2, '0');

                return `${year}-${month}-${day}T${hours}:${minutes}`;
            }

            // ========== EDIT FLIGHT - SUBMIT ==========
            document.getElementById('editFlightForm').addEventListener('submit', async function (e) {
                e.preventDefault();

                const flightId = document.getElementById('editFlightId').value;

                const data = {
                    flightNumber: document.getElementById('editFlightNumber').value,
                    price: parseFloat(document.getElementById('editPrice').value),
                    routeId: parseInt(document.getElementById('editRouteId').value),
                    aircraftId: parseInt(document.getElementById('editAircraftId').value),
                    departureTime: document.getElementById('editDepartureTime').value,
                    arrivalTime: document.getElementById('editArrivalTime').value,
                    availableSeats: parseInt(document.getElementById('editAvailableSeats').value)
                };

                // Validate
                const aircraftSelect = document.getElementById('editAircraftId');
                if (!aircraftSelect.value) {
                    alert('Please select an aircraft.');
                    return;
                }
                const selectedOption = aircraftSelect.options[aircraftSelect.selectedIndex];
                const capacityMatch = selectedOption.text.match(/(\d+)\s+seats/);

                if (!capacityMatch) {
                    alert('Cannot determine aircraft capacity. Please check select options.');
                    return;
                }
                const capacity = parseInt(capacityMatch[1]);

                if (data.availableSeats > capacity) {
                    alert('Available seats cannot exceed aircraft capacity (' + capacity + ')');
                    return;
                }

                if (new Date(data.arrivalTime) <= new Date(data.departureTime)) {
                    alert('Arrival time must be after departure time');
                    return;
                }

                try {
                    const response = await fetch(contextPath + `api/admin/flights/${flightId}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert('Flight updated successfully!');
                        var editModal = bootstrap.Modal.getInstance(document.getElementById('editFlightModal'));
                        editModal.hide();
                        location.reload();
                    } else {
                        alert('Failed to update flight: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred. Please try again.');
                }
            });

            // ========== ADD FLIGHT - SUBMIT (Sửa lỗi validation) ==========
            document.getElementById('addFlightForm').addEventListener('submit', async function (e) {
                e.preventDefault();

                const data = {
                    flightNumber: document.getElementById('flightNumber').value,
                    price: parseFloat(document.getElementById('price').value),
                    routeId: parseInt(document.getElementById('routeId').value),
                    aircraftId: parseInt(document.getElementById('aircraftId').value),
                    departureTime: document.getElementById('departureTime').value,
                    arrivalTime: document.getElementById('arrivalTime').value,
                    availableSeats: parseInt(document.getElementById('availableSeats').value)
                };

                // Validate
                const aircraftSelect = document.getElementById('aircraftId');
                if (!aircraftSelect.value) {
                    alert('Please select an aircraft.');
                    return;
                }
                const selectedOption = aircraftSelect.options[aircraftSelect.selectedIndex];
                const capacityMatch = selectedOption.text.match(/(\d+)\s+seats/);

                if (!capacityMatch) {
                    alert('Cannot determine aircraft capacity. Please check select options.');
                    return;
                }
                const capacity = parseInt(capacityMatch[1]);


                if (data.availableSeats > capacity) {
                    alert('Available seats cannot exceed aircraft capacity (' + capacity + ')');
                    return;
                }

                if (new Date(data.arrivalTime) <= new Date(data.departureTime)) {
                    alert('Arrival time must be after departure time');
                    return;
                }

                try {
                    const response = await fetch(contextPath + 'api/admin/flights', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert('Flight added successfully!');
                        var addModal = bootstrap.Modal.getInstance(document.getElementById('addFlightModal'));
                        addModal.hide();
                        location.reload();
                    } else {
                        alert('Failed to add flight: ' + result.message);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('An error occurred. Please try again.');
                }
            });
        </script>
    </body>
</html>